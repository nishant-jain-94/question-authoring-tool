<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box-light.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/web-animations-js/web-animations-next-lite.min.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="list-pane.html">
<link rel="import" href="jquery-import.html">

<dom-module id="question-authoring-tool-app">
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
        width: 100%;
        font-family: 'Lato', sans-serif;
      }
      .qa-container {
        display: flex;
        height: 100%;
        width: 100%;
        background: whitesmoke;
      }
      .qa-menu {
        width: 15%;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: linear-gradient(-45deg,#3f3c52 0,#161518 100%);
      }
      .qa-meta-composer {
        width: 25%;
        display: flex;
        flex-direction: column;
        height: 100%;
        padding-left: 20px;
        padding-right: 20px;
        position: relative;
        box-sizing: border-box;
      }
      .qa-composer {
        height: 100%;
        width: 35%;
        display: flex;
        flex-direction: column;
        background: white;
      }
      .qa-compose-btn {
        position: absolute;
        bottom: 30px;
        right: 30px;
      }
      .qa-menu-item {
        font-size: 1em;
        padding-left: 15px;
        color: whitesmoke;
      }
      .qa-folders {
        padding-top: 20px;
      }

      .qa-folders > .qa-folders-title  {
        font-weight: lighter !important;
        color: whitesmoke;
        font-size: 1.5em;
      }

      .qa-folders > .qa-folders-list {
        --paper-listbox-background-color: transparent;
        --paper-listbox-color: whitesmoke;
        --paper-listbox: {
          font-size: 1.2em;
        }
      }

      .qa-meta-composer > .qa-meta-composer-title > h1 {
        font-weight: lighter !important;
      }
      .qa-action-buttons {
        display: flex;
        flex-direction: row-reverse;
      }
      .qa-question-creator-btn {
        display: flex;
        padding-top: 20px;
        justify-content: flex-end;
      }
      .qa-list-pane {
        width: 30%;
        height: 100%;
        max-height: 100%;
      }
      .fullscreen-dialog{
        height: 100%;
        width: 100%;
        margin: 0px !important;
      }
      .overlay-close-btn-container{
        position: fixed;
        right: 20px;
        top: 5px;
        margin: 0;
        padding: 0;
      }
      .overlay-close-btn{
        color: #c2c2c2;
        width: 50px;
        height: 50px;
      }
      .csv_upload_form_container {
        margin-top: 60px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .csv_status_table{
        flex-grow: 1;
      }
      .csv_status_table_title{
        text-align: center;
      }
    </style>
    
    <div class="qa-container">
      <div class="qa-menu">
        <div class="qa-menu-item"><h1>Scribe</h1></div>
        <div class="qa-folders">
          <div class="qa-menu-item qa-folders-title">Questions</div>
          <paper-listbox class="qa-folders-list" attr-for-selected="folder" selected="{{selectedFolder}}">
            <dom-repeat items="{{folders}}" as="folder">
              <template>
                <paper-item folder="{{folder}}">{{folder.displayName}}</paper-item>
              </template>
            </dom-repeat>
            <paper-item on-click="_openFileUploadDialog">CSV Upload</paper-item>
          </paper-listbox>
        </div>
      </div>

      <list-pane class="qa-list-pane" items="{{selectedFolder.questions}}" 
                 title="{{selectedFolder.title}}"
                 first-line-item-path="{{selectedFolder.firstLineItemPath}}" 
                 second-line-item-path="{{selectedFolder.secondLineItemPath}}" 
                 selected-item="{{selectedFolder.selectedItem}}">
      </list-pane>
      
      <div class="qa-meta-composer">
        <div class="qa-meta-composer-title"><h1>Meta Data</h1></div>
        <vaadin-combo-box-light selected-item="{{selectedConcept}}" items="{{conceptComboBox.suggestedItems}}" attr-for-value="bind-value" item-label-path="name" item-value-path="name">
          <paper-input value="{{conceptComboBox.searchTerm}}" placeholder="Concept"></paper-input>
          <template>
            <style>
              .vaadin-custom {
                font-family: 'Lato', sans-serif;
                font-size: 1.2em;
              }
            </style>
            <div class="vaadin-custom">
              [[item.name]]
            </div>
          </template>
        </vaadin-combo-box-light>
        <vaadin-combo-box-light selected-item="{{selectedContent}}" items="{{contentComboBox.suggestedItems}}" attr-for-value="bind-value" item-label-path="name" item-value-path="name">
          <paper-input value="{{contentComboBox.searchTerm}}" placeholder="Content"></paper-input>
          <template>
            <style>
              .vaadin-custom {
                font-family: 'Lato', sans-serif;
                font-size: 1.2em;
              }
            </style>
            <div class="vaadin-custom">
              [[item.name]]
            </div>
          </template>
        </vaadin-combo-box-light>
        <vaadin-combo-box-light selected-item="{{selectedExpectedOutcome}}" items="{{expectedOutcomeComboBox.suggestedItems}}" attr-for-value="bind-value" item-label-path="displayName" item-value-path="displayName">
          <paper-input value="" placeholder="Expected Outcome"></paper-input>
          <template>
              <style>
                .vaadin-custom {
                  font-family: 'Lato', sans-serif;
                  font-size: 1.2em;
                }
              </style>
              <div class="vaadin-custom">
                Should be able to [[item.displayName]]
              </div>
            </template>  
        </vaadin-combo-box-light>
        <vaadin-combo-box-light selected-item="{{selectedQuestionType}}" items="{{questionTypeComboBox.suggestedItems}}"            attr-for-value="bind-value" item-label-path="displayName" item-value-path="displayName">
          <paper-input value="" placeholder="Question Type"></paper-input>
          <template>
            <style>
              .vaadin-custom {
                font-family: 'Lato', sans-serif;
                font-size: 1.2em;
              }
            </style>
            <div class="vaadin-custom">
              [[item.displayName]]
            </div>
          </template>  
        </vaadin-combo-box-light>
        <div class="qa-question-creator-btn">
          <paper-button on-click="_renderPlayer">Create Question</paper-button>
        </div>
      </div>
      <div class="qa-composer" id="player"></div>
    </div>
    <paper-dialog 
      id="csv_upload" 
      class="fullscreen-dialog"
      opened="{{csvUploadDialog.opened}}"
      entry-animation="scale-up-animation" 
      exit-animation="scale-down-animation"
    >
      <span class="overlay-close-btn-container">
        <paper-icon-button on-click="_closeFileUploadDialog" class="overlay-close-btn" icon="close"></paper-icon-button>
      </span>
      <div class="csv_upload_form_container">
        <vaadin-upload id="uploadCSVField" max-files="1" name="myFile" on-upload-success="_closeFileUploadDialog" form-data-name="myFile" method="post" target="http://localhost:4000/fileupload">
          <span slot="drop-label">Click Upload or drop the CSV file</span>
        </vaadin-upload>
        <div class="csv_status_table">
          <h3 class="csv_status_table_title">Status of Uploaded CSVs</h3>
          <vaadin-grid items="[[CSVStatusData]]" size="100">
        
            <vaadin-grid-column width="50px" flex-grow="0">
              <template class="header">#</template>
              <template>[[index]]</template>
            </vaadin-grid-column>
        
            <vaadin-grid-column width="calc(50% - 400px)">
              <template class="header">File Name</template>
              <template>[[item.fileName]]</template>
            </vaadin-grid-column>
        
            <vaadin-grid-column width="calc(50% - 400px)">
              <template class="header">Status</template>
              <template>
                <p style="white-space:normal">[[item.status]]</p>
              </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="calc(50% - 100px)">
              <template class="header">Errors</template>
              <template>
                <p style="white-space:normal">[[item.errorMessages]]</p>
              </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="calc(50% - 400px)">
              <template class="header">Uploaded at</template>
              <template>[[item.updatedAt]]</template>
            </vaadin-grid-column>
            
            <!-- <vaadin-grid-column width="calc(50% - 50px)">
              <template class="header">Action</template>
              <template>[[item.name.last]]</template>
            </vaadin-grid-column> -->

          </vaadin-grid>
        </div>
      </div>
    </paper-dialog>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class QuestionAuthoringToolApp extends Polymer.Element {
      static get is() { return 'question-authoring-tool-app'; }
      static get properties() {
        return {
          conceptComboBox: {
            type: Object,
            value: function() {
              return {
                searchTerm: '',
                suggestedItems: []
              }
            },
          },
          contentComboBox: {
            type: Object,
            value: function() {
              return {
                searchTerm: '',
                suggestedItems: []
              }
            }
          },
          currentQuestion: {
            type: Object,
            value: {},
          },
          expectedOutcomeComboBox: {
            type: Object,
            value: function() {
              return {
                suggestedItems: [
                  { displayName: 'Remember' },
                  { displayName: 'Comprehend' },
                  { displayName: 'Apply' },
                  { displayName: 'Analyze' },
                  { displayName: 'Synthesize' },
                  { displayName: 'Evaluate' }
                ]
              }
            }
          },
          subject: {
            type: String
          },
          selectedConcept: {
            type: Object
          },
          selectedContent: {
            type: Object
          },
          selectedFolder: {
            type: Object
          },
          folders: {
            type: Object,
            value: function() {
              return [
                {
                  title: 'Published Questions',
                  displayName: 'Published',
                  property: 'publishedQuestions',
                  url: 'http://localhost:4000/question',
                  firstLineItemPath: 'concept',
                  secondLineItemPath: 'content',
                  questions: [],
                },
                {
                  title: 'Drafts',
                  displayName: 'Drafts',
                  property: 'drafts',
                  url: 'http://localhost:4000/questions/draft',
                  firstLineItemPath: 'concept',
                  secondLineItemPath: 'content',
                  questions: [],
                }
              ]
            }
          },
          questionTypeComboBox: {
            type: Object,
            value: function() {
              return {
                suggestedItems: [
                  { 
                    displayName: 'Multiple Choice Question',
                    questionType: 'Multiple Choice Question',
                    player: 'mcq-player'
                  },
                  { 
                    displayName: 'Multiselect Questions',
                    questionType: 'Multiselect Question',
                    player: 'msq-player'
                  },
                  { 
                    displayName: 'Subjective Question',
                    questionType: 'Subjective Question',
                    player: 'subj-player'
                  },
                  { 
                    displayName: 'Programming Question',
                    questionType: 'Programming Question',
                    player: 'prog-question'
                  }
                ]
              }
            },
            
            selectedQuestionType: {
              type: Object
            },
            selectedExpectedOutcome: {
              type: Object
            },
          },
          CSVStatusData: {
            type: Array,
            notify: true,
          },
        }
      }

      static get observers() {
        return [
          '_conceptSearchValueChanged(conceptComboBox.searchTerm)',
          '_contentSearchValueChanged(contentComboBox.searchTerm)',
          '_foldersPopulated(folders)',
          '_fetchQuestions(selectedFolder)',
        ]
      }

      _foldersPopulated(folders) {
        this.set('selectedFolder', folders[0]);
      }

      _fetchQuestions(selectedFolder) {
        $.ajax({
          url: selectedFolder.url,
          method: 'GET',
          success: (questions) => {
            // Array.prototype.push.apply(selectedFolder.questions, questions);
            if(this.selectedFolder.title == selectedFolder.title) {
              this.set('selectedFolder.questions', questions);
            }
          }
        });
      }

      _conceptSearchValueChanged(searchTerm) {
        if(searchTerm.length > 3) {
          $.ajax({
            url: 'http://localhost:9090/concept/search',
            method: 'POST',
            data: {
              "searchTerm": searchTerm
            },
            success: (results) => {
              this.set('conceptComboBox.suggestedItems', results);
            },
            error: (error) => {
              console.log(error);
            }
          });
        }
      }

      _contentSearchValueChanged(searchTerm) {
        if(searchTerm.length > 3) {
          $.ajax({
            url: 'http://localhost:9090/content/search',
            method: 'POST',
            data: {
              "searchTerm": searchTerm
            },
            success: (results) => {
              this.set('contentComboBox.suggestedItems', results);
            },
            error: (error) => {
              console.log(error);
            }
          });
        }
      }

      _renderPlayer() {
        const questionAuthoringResolvedUrl = this.resolveUrl(`../../bower_components/${this.selectedQuestionType.player}/${this.selectedQuestionType.player}-authoring-mode/${this.selectedQuestionType.player}-authoring-mode.html`);        
        Polymer.importHref(questionAuthoringResolvedUrl);
        this.$.player.innerHTML = `<${this.selectedQuestionType.player}-authoring-mode id="authoringtool"></${this.selectedQuestionType.player}-authoring-mode>`;

        this.$.player.getElementsByTagName(`${this.selectedQuestionType.player}-authoring-mode`)[0].addEventListener('questionPublished', this._onQuestionPublished.bind(this));
      }

      _onQuestionPublished({ detail }) {
        this.currentQuestion.concept = this.selectedConcept.name;
        this.currentQuestion.content = this.selectedContent.name;
        this.currentQuestion.expectedOutcome = this.selectedExpectedOutcome.displayName;
        this.currentQuestion.evaluator = 'mcq-evaluator';
        this.currentQuestion.questionType = 'Multiple Choice Question';
        this.currentQuestion.answer = detail.answer;
        this.currentQuestion.player = 'mcq-player';
        delete detail.answer;
        this.currentQuestion.question = detail;

        $.post({
          url: 'http://localhost:4000/question',
          dataType: 'json',
          data: JSON.stringify(this.currentQuestion),
          contentType: "application/json; charset=utf-8",
          success: (publishedQuestion) => {
            this.$.player.innerHTML = '';
            if(this.selectedFolder.title === 'Published Questions') {
              this.push('selectedFolder.questions', publishedQuestion);
            }
          },
          error: (error) => {
            this.$.player.innerHTML = '';
          }
        });
      }

      _openFileUploadDialog() {
        this.$.csv_upload.opened = true;
        this._fetchCSVStatus(this.CSVStatusData);
      }

      _closeFileUploadDialog() {
        this.$.uploadCSVField.files = [];
        this.$.csv_upload.opened = false;
      }

      _fetchCSVStatus(CSVStatusData) {
        $.ajax({
          url: 'http://localhost:4000/fileUpload',
          method: 'GET',
          success: (statuses) => {
            this.set('CSVStatusData', statuses);
          }
        });
      }
    }

    window.customElements.define(QuestionAuthoringToolApp.is, QuestionAuthoringToolApp);
  </script>
</dom-module>
